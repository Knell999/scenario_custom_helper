#!/bin/bash
set -e

# í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
check_env_vars() {
    echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì¤‘..."
    
    if [ -z "$GOOGLE_API_KEY" ]; then
        echo "âš ï¸  ê²½ê³ : GOOGLE_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        echo "   Docker ì‹¤í–‰ ì‹œ -e GOOGLE_API_KEY=your_api_keyë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
    else
        echo "âœ… GOOGLE_API_KEY í™•ì¸ë¨"
    fi
}

# ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
setup_directories() {
    echo "ğŸ“ ë””ë ‰í† ë¦¬ ì„¤ì • ì¤‘..."
    
    # saved_stories ë””ë ‰í† ë¦¬ê°€ ì“°ê¸° ê°€ëŠ¥í•œì§€ í™•ì¸
    if [ ! -w "saved_stories" ]; then
        echo "âš ï¸  saved_stories ë””ë ‰í† ë¦¬ ê¶Œí•œ ìˆ˜ì • ì¤‘..."
        chmod 755 saved_stories logs 2>/dev/null || echo "âš ï¸ ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨ - ë¬´ì‹œí•˜ê³  ê³„ì†ì§„í–‰" 
    fi
    
    echo "âœ… ë””ë ‰í† ë¦¬ ì„¤ì • ì™„ë£Œ"
}

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
start_application() {
    case "$1" in
        "streamlit")
            echo "ğŸš€ Streamlit ì•± ì‹œì‘ ì¤‘..."
            exec streamlit run app.py \
                --server.address=0.0.0.0 \
                --server.port=8501 \
                --server.headless=true \
                --server.fileWatcherType=none \
                --browser.gatherUsageStats=false
            ;;
        "fastapi")
            echo "ğŸš€ FastAPI ì„œë²„ ì‹œì‘ ì¤‘..."
            exec uvicorn main:app \
                --host 0.0.0.0 \
                --port 8000
            ;;
        "both")
            echo "ğŸš€ Streamlitê³¼ FastAPI ë™ì‹œ ì‹œì‘ ì¤‘..."
            # FastAPIë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
            uvicorn main:app --host 0.0.0.0 --port 8000 &
            # Streamlitì„ í¬ì–´ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
            exec streamlit run app.py \
                --server.address=0.0.0.0 \
                --server.port=8501 \
                --server.headless=true \
                --server.fileWatcherType=none \
                --browser.gatherUsageStats=false
            ;;
        *)
            echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì„œë¹„ìŠ¤: $1"
            echo "ì‚¬ìš©ë²•: docker-entrypoint.sh [streamlit|fastapi|both]"
            exit 1
            ;;
    esac
}

# ë©”ì¸ ì‹¤í–‰
main() {
    echo "ğŸ³ Making Story Chatbot Docker ì»¨í…Œì´ë„ˆ ì‹œì‘"
    echo "================================================"
    
    check_env_vars
    setup_directories
    
    # ê¸°ë³¸ê°’ì€ streamlit
    SERVICE=${1:-streamlit}
    start_application "$SERVICE"
}

main "$@"
